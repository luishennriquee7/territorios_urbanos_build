workflows:
  android_release:
    name: Build APK (OSM)
    # usa máquina gratuita
    instance_type: linux
    max_build_duration: 60

    environment:
      flutter: stable
      # sem iOS/xcode; só Android
      vars:
        APP_DIR: app

    cache:
      cache_paths:
        - ~/.pub-cache
        - $APP_DIR/build

    scripts:
      - name: Versões das ferramentas
        script: |
          flutter --version
          dart --version
          java -version

      # Como seu repositório não é um projeto Flutter "padrão",
      # criamos um esqueleto e injetamos os arquivos da pasta ci/
      - name: Criar esqueleto Flutter
        script: |
          rm -rf $APP_DIR
          flutter create $APP_DIR

      - name: Injetar arquivos do app
        script: |
          # pubspec e main.dart
          cp -f ci/pubspec.yaml $APP_DIR/pubspec.yaml
          mkdir -p $APP_DIR/lib
          cp -f ci/lib_main.dart $APP_DIR/lib/main.dart

          # Manifest Android
          mkdir -p $APP_DIR/android/app/src/main
          cp -f ci/AndroidManifest.xml $APP_DIR/android/app/src/main/AndroidManifest.xml

      - name: Instalar dependências
        script: |
          cd $APP_DIR
          flutter pub get

      - name: Build APK release
        script: |
          cd $APP_DIR
          # gera app-release.apk (sem assinatura própria)
          flutter build apk --release --verbose

    artifacts:
      - $APP_DIR/build/app/outputs/flutter-apk/app-release.apk

    publishing:
      email:
        recipients:
          # opcional: troque pelo seu e-mail para receber o APK por e-mail
          - luishennriquee7@gmail.com
        notify:
          success: true
          failure: true
