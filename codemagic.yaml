workflows:
  android_release:
    name: Build APK (OSM)
    # usa a máquina Linux gratuita do Codemagic
    instance_type: linux
    max_build_duration: 60

    environment:
      flutter: stable
      vars:
        APP_DIR: app

    cache:
      cache_paths:
        - ~/.pub-cache
        - $APP_DIR/build

    scripts:
      - name: Versões das ferramentas
        script: |
          flutter --version
          dart --version
          java -version

      # seu repositório não é um projeto Flutter padrão;
      # criamos um esqueleto e injetamos os arquivos da pasta ci/
      - name: Criar esqueleto Flutter
        script: |
          rm -rf $APP_DIR
          flutter create $APP_DIR

      - name: Injetar arquivos do app
        script: |
          # pubspec + código
          cp -f ci/pubspec.yaml $APP_DIR/pubspec.yaml
          mkdir -p $APP_DIR/lib
          cp -f ci/lib_main.dart $APP_DIR/lib/main.dart

          # Manifest Android
          mkdir -p $APP_DIR/android/app/src/main
          cp -f ci/AndroidManifest.xml $APP_DIR/android/app/src/main/AndroidManifest.xml

      - name: Instalar dependências
        script: |
          cd $APP_DIR
          flutter pub get

      - name: Build APK release
        script: |
          cd $APP_DIR
          # APK sem assinatura própria (debug/release genérica)
          flutter build apk --release --verbose

    artifacts:
      - $APP_DIR/build/app/outputs/flutter-apk/app-release.apk

    publishing:
      email:
        recipients:
          # troque para seu e-mail se quiser receber o APK
          - luishenriquee7@gmail.com
